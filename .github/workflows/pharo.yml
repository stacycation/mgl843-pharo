name: Pharo CI

on:
  push:
  pull_request:

concurrency:
  group: pharo-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache Pharo + smalltalkCI + Metacello
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache
            ~/.pharo
            ~/.smalltalkCI
          key: ${{ runner.os }}-pharo11-${{ hashFiles('.smalltalk.ston', 'src/**') }}
          restore-keys: |
            ${{ runner.os }}-pharo11-

      - name: Setup Pharo (smalltalkCI)
        uses: hpi-swa/setup-smalltalkCI@v1
        with:
          smalltalk-image: Pharo64-11

      - name: Show repo + spec used by CI
        run: |
          set -euxo pipefail
          echo "Ref: $GITHUB_REF"
          echo "SHA: $GITHUB_SHA"
          git log -1 --oneline
          echo "=== .smalltalk.ston ==="
          cat .smalltalk.ston
          echo "======================"

      - name: Ensure Tonel src exists (and list)
        run: |
          set -euxo pipefail
          test -d src
          ls -la src | head -n 200

      - name: Check Baseline exists in src (BaselineOfMGL843)
        run: |
          set -euxo pipefail
          if ! find src -maxdepth 4 -type f -iname "*BaselineOfMGL843*" | head -n 1 | grep -qi "BaselineOfMGL843"; then
            echo "::error::BaselineOfMGL843 not found under ./src. Metacello cannot load your project."
            echo "Files under src (first 300):"
            find src -maxdepth 4 -type f | head -n 300
            exit 1
          fi
          echo "OK: BaselineOfMGL843 found."

      - name: Clean previous build folder (avoid stuck state)
        run: |
          set -euxo pipefail
          rm -rf ~/.smalltalkCI/_builds || true

      - name: Load + Test via smalltalkCI
        timeout-minutes: 20
        run: |
          set -euxo pipefail
          smalltalkci -s Pharo64-11 .smalltalk.ston

      - name: Upload artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pharo-artifacts
          path: |
            *.image
            *.changes
            PharoDebug.log
            ~/.smalltalkCI/_builds/**/*
          if-no-files-found: ignore
