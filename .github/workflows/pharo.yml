name: Pharo CI

on:
  push:
  pull_request:

concurrency:
  group: pharo-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Pharo
        uses: hpi-swa/setup-smalltalkCI@v1
        with:
          smalltalk-image: Pharo64-11

      - name: Cache Pharo + Metacello
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache
            ~/.pharo
            ~/.smalltalkCI
          key: ${{ runner.os }}-pharo11-${{ hashFiles('src/**', '.smalltalk.ston') }}
          restore-keys: |
            ${{ runner.os }}-pharo11-       

      - name: Ensure Iceberg layout exists
        run: |
          if [ ! -d "src" ]; then
            echo "::error::Missing ./src directory (Tonel)."
            exit 1
          fi
          echo "src contents:"
          ls -la src

      - name: Show .smalltalk.ston used by CI
        run: |
          echo "=== .smalltalk.ston ==="
          cat .smalltalk.ston
          echo "======================"

      - name: Load + Test via smalltalkCI
        run: |
          smalltalkci -s Pharo64-11 .smalltalk.ston

      - name: Upload artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pharo-artifacts
          path: |
            *.image
            *.changes
            PharoDebug.log
          if-no-files-found: ignore
